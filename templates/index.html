{% extends '_base.html' %}
{% block content %}
<script>
    var lowestid,end=false,updating=false;
    const ws = new WebSocket("ws://" + window.location.host + "/record/ws/");
    ws.onopen = (event)=>{
        ws.send('{"type":"{{type}}","id":{{id}}}');
    }
    ws.onmessage = (event)=>{
        const data = JSON.parse(event.data);
        update(data);
    }
    const update = (data) => {
        if(data.status==404)
        {
            document.getElementById("spinner-border").style.display = "none";
            document.getElementById("end-text").style.display = "block";
            end=true;
        }
        if(data.status==403)
        {
            document.getElementById("spinner-border").style.display = "none";
            document.getElementById("end-text").style.display = "block";
            document.getElementById("end-text").innerText = "你没有查看此处日志的权限";
            end=true;
        }
        if(data.status!=200)
        {
            return;
        }
        var html = `
<a onclick="popup(${data.id})" href="javascript:void(0);">${data.title} - ${data.errcode}</a>
<span class="float-right text-muted">${data.created_time}</span><br>
<span class="text-muted">工厂：${data.factory}</span>
<span class="float-right text-muted">车间：${data.garage}</span><br>
<span class="text-muted">流水线：${data.pipeline}</span>
<span class="float-right text-muted">机器：${data.machine}</span>`.replace("\n","");
        const node = document.createElement("li");
        node.className = "list-group-item";
        node.innerHTML = html;
        localStorage.setItem(data.id,JSON.stringify(data));
        if(data.position == "up")
        {
            document.getElementById("data").insertBefore(node,document.getElementById("data").firstChild);
        }
        else
        {
            document.getElementById("data").appendChild(node);
            lowestid = data.id;
        }
        updating=false;
        scheck();
    }

    const scheck = () => {
        if(end||updating)
        {
            return;
        }
        updating=true;
        var visibleBottom = window.scrollY + document.documentElement.clientHeight;
        var spinner = document.getElementById("spinner");
        var spinnerY = spinner.offsetTop;
        if(spinnerY<visibleBottom+1600)
        {
            var query={};
            query.lowestid = lowestid;
            ws.send(JSON.stringify(query));
        }
        else
        {
            updating = false;
        }
    }
    document.addEventListener('scroll',scheck);
    const filter = () => {
        document.getElementById("spinner-border").style.display = "block";
        document.getElementById("end-text").style.display = "none";
        end=false;
        var i;
        var filterform = document.getElementById("filter");
        var inputs = filterform.getElementsByTagName("input");
        document.getElementById("data").innerHTML = "";
        var dict = {"type":"{{type}}","id":{{id}} };
        dict["filter"] = [];
        for(i=0;i<inputs.length;++i)
        {
            dict["filter"].push(inputs[i].value);
        }
        ws.send(JSON.stringify(dict));
        document.getElementById("exportbutton").setAttribute("href",`/record/export/{{type}}/{{id}}/?filter=${encodeURIComponent(JSON.stringify(dict["filter"]))}`)
    }
    localStorage.setItem("writable","{%if writable%}W{%else%}-{%endif%}");
</script>
<nav>
    <ol class="breadcrumb">
        {%if type == "garage"%}
        <li class="breadcrumb-item"><a href="/record/factory/{{object.factory.id}}/">{{object.factory.index}}</a></li>
        {%elif type == "pipeline"%}
        <li class="breadcrumb-item"><a href="/record/factory/{{object.garage.factory.id}}/">{{object.garage.factory.index}}</a></li>
        <li class="breadcrumb-item"><a href="/record/garage/{{object.garage.id}}/">{{object.garage.index}}</a></li>
        {%endif%}
        <li class="breadcrumb-item active">{{object.index}}</li>
        {%if type == "factory"%}
        <li class="breadcrumb-item">
            <span>{</span>
            {%for i in object.garage_set.all%}
            <a class="ml-1 mr-1" href="/record/garage/{{i.id}}/">{{i.index}}</a>
            {%endfor%}
            <span>}</span>
        </li>
        {%elif type == "garage"%}
        <li class="breadcrumb-item">
            <span>{</span>
            {%for i in object.pipeline_set.all%}
            <a class="ml-1 mr-1" href="/record/pipeline/{{i.id}}/">{{i.index}}</a>
            {%endfor%}
            <span>}</span>
        </li>
        {%endif%}
    </ol>
</nav>
{%if writable and type == "pipeline"%}
<a class="btn btn-primary text-white mb-2 mr-3" href="/record/add/?id={{object.id}}">添加新纪录</a>
{%endif%}
{%if exportable%}
<a id="exportbutton" class="btn btn-primary text-white mb-2 mr-3" href="/record/export/{{type}}/{{id}}/">导出所有记录</a>
{%endif%}
<button class="btn btn-primary mb-2 mr-3" data-target="#filter" data-toggle="collapse">筛选</button>
<div class="collapse mb-3" id="filter">
    <form class="form-inline">
        <input class="form-control mr-2" placeholder="标题/错误代码"/>
        <input class="form-control mr-2" placeholder="机器名称"/>
        <span>起始：</span><input class="form-control mr-2" type="date"/>
        <span>终止：</span><input class="form-control mr-2" type="date"/>
        <button class="btn btn-primary" type="button" onclick="filter()">应用</button>
    </form>
</div>
<ul class="list-group" id="data">
</ul>
<div class="d-flex justify-content-center" id="spinner">
    <div class="spinner-border" id="spinner-border">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<div class="text-muted text-center" style="display:none;" id="end-text">已经到底了~~~</div>
{% include "components/content_modal.html" %}
{%endblock%}